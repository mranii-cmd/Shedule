<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Emploi du Temps v3 - Application Modulaire</title>


    <!-- Chart.js pour les graphiques du dashboard 
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script> -->
    <!-- Styles -->
    <link rel="stylesheet" href="src/css/main.css">
    <style>
        /* Style pour le bouton wizard */
        #btnOpenExamWizard {
            position: relative;
            overflow: hidden;
        }

        #btnOpenExamWizard::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        #btnOpenExamWizard:hover::before {
            width: 300px;
            height: 300px;
        }

        /* Animation du summary */
        details summary {
            transition: all 0.3s ease;
        }

        details summary:hover {
            background: #e9ecef !important;
        }

        details[open] summary {
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }
    </style>


</head>

<body>


    <!-- Spinner de chargement -->
    <div id="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- Zone de notifications -->
    <div id="edt-notification-area"></div>

    <!-- Conteneur principal -->
    <div class="app-container">
        <!-- En-t√™te -->
        <div id="page-header">
            <div>
                <label for="inputAnneeUniversitaire">Ann√©e :</label>
                <input type="text" id="inputAnneeUniversitaire" placeholder="2024/2025">
            </div>
            <div>
                <label for="selectSession">Session :</label>
                <select id="selectSession">
                    <option value="Session d'automne">Session d'automne</option>
                    <option value="Session de printemps">Session de printemps</option>
                </select>
            </div>
            <div>
                <label for="selectDepartement">D√©partement :</label>
                <select id="selectDepartement">
                    <option>D√©partement de physique</option>
                    <option>D√©partement de chimie</option>
                    <option>D√©partement de Biologie</option>
                    <option>D√©partement de math√©matiques</option>
                    <option>D√©partement d'informatique</option>
                    <option>D√©partement de G√©ologie</option>
                    <option>D√©partement Modules Transversaux</option>
                    <option>Administration</option>
                </select>
            </div>
            <div id="header-actions">
                <button id="saveBtn" class="save-btn">üíæ Enregistrer</button>
                <button id="btnManageCreneaux" class="btn" title="G√©rer les cr√©neaux">‚è±Ô∏è G√©rer Cr√©neaux</button>
                <button id="btnUndo" class="btn" title="Annuler la derni√®re modification" style="margin-left:8px;">‚Ü∂
                    Annuler</button>
            </div>
        </div>

        <h1>üß† Gestion Emploi du Temps v2.9 - Modulaire</h1>

        <!-- Navigation par Onglets -->
        <div class="tabs-container">
            <button class="tab-btn active" data-tab="planning">üìÖ Planification</button>
            <button class="tab-btn" data-tab="dashboard">üìä Dashboard</button>
            <button class="tab-btn" data-tab="config">üîß Configuration</button>
            <button class="tab-btn" data-tab="volumes">üìä Volumes Horaires</button>
            <button class="tab-btn" data-tab="stats">üìà Statistiques</button>
            <button class="tab-btn" data-tab="gestion">üë• Gestion</button>
            <button class="tab-btn" data-tab="salles">üèõÔ∏è Gestion Salles</button> <!-- NOUVEAU -->
            <button class="tab-btn" data-tab="souhaits">üí≠ Souhaits Enseignants</button>
            <button class="tab-btn" data-tab="rapports">üìÑ Rapports & Export</button>
            <!-- <button class="tab-btn" data-tab="exam-timetable">üìÜ Emploi du temps</button> -->
            <button class="tab-btn" data-tab="examens">üìù Examens</button>

        </div>

        <!-- Contenu des Onglets -->

        <!-- ===== ONGLET PLANIFICATION ===== -->
        <div id="tab-planning" class="tab-pane active">
            <!-- <h2>üìÖ Planification Automatique</h2> -->

            <!-- Options de planification -->
            <div class="planning-options-panel">
                <h3>‚öôÔ∏è Options de G√©n√©ration</h3>
                <label><input type="checkbox" id="optionAssignTeachers" checked> Attribuer automatiquement les
                    enseignants</label>
                <label><input type="checkbox" id="optionAssignRooms" checked> Attribuer automatiquement les
                    salles</label>
                <label><input type="checkbox" id="optionRespectWishes" checked> Respecter les souhaits des
                    enseignants</label>
                <label><input type="checkbox" id="optionAvoidConflicts" checked> √âviter les conflits</label>
            </div>

            <!-- Actions de planification -->
            <div class="planning-actions">
                <button id="btnAutoGenerateAll" class="btn btn-primary">
                    üöÄ G√©n√©rer Toutes les S√©ances
                </button>
                <!-- ===== OPTIONS AVANC√âES D'OPTIMISATION ===== -->
                <div id="optimizationOptionsPanel"
                    style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #e9ecef;">
                    <h4 style="margin: 0 0 15px 0; color: #667eea;">
                        <span style="font-size: 1.3em;">‚öôÔ∏è</span> Options d'optimisation
                    </h4>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Colonne gauche -->
                        <div>
                            <h5 style="margin: 0 0 10px 0; color: #495057; font-size: 1em;">Priorit√©s</h5>

                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="optRemoveGaps" checked
                                        style="margin-right: 10px; width: 18px; height: 18px;">
                                    <span>
                                        <strong>Supprimer les trous</strong>
                                        <br>
                                        <small style="color: #6c757d;">Compacter les s√©ances pour √©viter les temps
                                            morts</small>
                                    </span>
                                </label>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="optBalanceLoad" checked
                                        style="margin-right: 10px; width: 18px; height: 18px;">
                                    <span>
                                        <strong>√âquilibrer la charge</strong>
                                        <br>
                                        <small style="color: #6c757d;">R√©partir √©quitablement les heures par
                                            jour</small>
                                    </span>
                                </label>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="optGroupSubjects" checked
                                        style="margin-right: 10px; width: 18px; height: 18px;">
                                    <span>
                                        <strong>Regrouper les mati√®res</strong>
                                        <br>
                                        <small style="color: #6c757d;">Regrouper les s√©ances d'une m√™me mati√®re</small>
                                    </span>
                                </label>

                                <!-- D√©tails du regroupement -->
                                <div id="groupSubjectsDetails"
                                    style="margin-left: 28px; margin-top: 8px; padding: 12px; background: #fff; border-left: 3px solid #667eea; border-radius: 4px; display: block;">

                                    <div style="margin-bottom: 10px;">
                                        <label style="display: block; margin-bottom: 5px;">
                                            <strong style="color: #667eea;">Strat√©gie de regroupement</strong>
                                        </label>
                                        <select id="optGroupStrategy"
                                            style="width: 100%; padding: 6px; border: 2px solid #e0e0e0; border-radius: 4px;">
                                            <option value="same-day" selected>M√™me jour (pr√©f√©r√©)</option>
                                            <option value="consecutive-days">Jours cons√©cutifs</option>
                                            <option value="spread">R√©partir sur la semaine</option>
                                        </select>
                                    </div>

                                    <div style="font-size: 0.85em; color: #495057;">
                                        <div
                                            style="margin-bottom: 5px; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                            <strong>üìÖ M√™me jour :</strong> Toutes les s√©ances d'une mati√®re le m√™me
                                            jour
                                        </div>
                                        <div
                                            style="margin-bottom: 5px; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                            <strong>üìÜ Jours cons√©cutifs :</strong> S√©ances sur 2-3 jours successifs
                                        </div>
                                        <div style="padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                            <strong>üìä R√©partir :</strong> S√©ances distribu√©es sur toute la semaine
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="optPreferredSlots" checked
                                        style="margin-right: 10px; width: 18px; height: 18px;">
                                    <span>
                                        <strong>Cr√©neaux pr√©f√©r√©s</strong>
                                        <br>
                                        <small style="color: #6c757d;">Appliquer les pr√©f√©rences horaires par type de
                                            s√©ance</small>
                                    </span>
                                </label>

                                <!-- D√©tails des pr√©f√©rences (affich√© si l'option est coch√©e) -->
                                <div id="preferredSlotsDetails"
                                    style="margin-left: 28px; margin-top: 8px; padding: 12px; background: #fff; border-left: 3px solid #667eea; border-radius: 4px; display: block;">

                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; margin-bottom: 5px;">
                                            <strong style="color: #667eea;">üìö Cours Magistraux (CM)</strong>
                                        </label>
                                        <select id="optCMSlot"
                                            style="width: 100%; padding: 6px; border: 2px solid #e0e0e0; border-radius: 4px;">
                                            <option value="morning" selected>Matin (8h-12h)</option>
                                            <option value="afternoon">Apr√®s-midi (14h-18h)</option>
                                            <option value="any">Peu importe</option>
                                        </select>
                                    </div>

                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; margin-bottom: 5px;">
                                            <strong style="color: #667eea;">üìù Travaux Dirig√©s (TD)</strong>
                                        </label>
                                        <select id="optTDSlot"
                                            style="width: 100%; padding: 6px; border: 2px solid #e0e0e0; border-radius: 4px;">
                                            <option value="morning">Matin (8h-12h)</option>
                                            <option value="afternoon" selected>Apr√®s-midi (14h-18h)</option>
                                            <option value="any">Peu importe</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label style="display: block; margin-bottom: 5px;">
                                            <strong style="color: #667eea;">üî¨ Travaux Pratiques (TP)</strong>
                                        </label>
                                        <select id="optTPSlot"
                                            style="width: 100%; padding: 6px; border: 2px solid #e0e0e0; border-radius: 4px;">
                                            <option value="morning">Matin (8h-12h)</option>
                                            <option value="afternoon" selected>Apr√®s-midi (14h-18h)</option>
                                            <option value="any">Peu importe</option>
                                        </select>
                                    </div>

                                    <div
                                        style="margin-top: 10px; padding: 8px; background: #e7f3ff; border-radius: 4px; font-size: 0.8em; color: #0c5460;">
                                        üí° Ces pr√©f√©rences seront utilis√©es lors de l'optimisation automatique
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Colonne droite -->
                        <div>
                            <h5 style="margin: 0 0 10px 0; color: #495057; font-size: 1em;">Param√®tres avanc√©s</h5>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">
                                    <strong>Tol√©rance de charge</strong>
                                    <small style="color: #6c757d;">(¬± heures par jour)</small>
                                </label>
                                <input type="number" id="optLoadTolerance" value="1.5" min="0" max="4" step="0.5"
                                    style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                                <small style="color: #6c757d;">Diff√©rence acceptable entre le jour le plus charg√© et le
                                    moins charg√©</small>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">
                                    <strong>Pause minimale</strong>
                                    <small style="color: #6c757d;">(minutes)</small>
                                </label>
                                <input type="number" id="optMinBreak" value="15" min="0" max="60" step="5"
                                    style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                                <small style="color: #6c757d;">Pause minimale entre deux s√©ances</small>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px;">
                                    <strong>Heure de fin maximum</strong>
                                </label>
                                <select id="optMaxEndTime"
                                    style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                                    <option value="17">17:00</option>
                                    <option value="18" selected>18:00</option>
                                    <option value="19">19:00</option>
                                    <option value="20">20:00</option>
                                </select>
                                <small style="color: #6c757d;">Ne pas planifier de s√©ances apr√®s cette heure</small>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="optRespectExisting" checked
                                        style="margin-right: 10px; width: 18px; height: 18px;">
                                    <span>
                                        <strong>Respecter les s√©ances verrouill√©es</strong>
                                        <br>
                                        <small style="color: #6c757d;">Ne pas modifier les s√©ances marqu√©es comme
                                            fixes</small>
                                    </span>
                                </label>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="optRespectConstraints" checked
                                        style="margin-right: 10px; width: 18px; height: 18px;">
                                    <span>
                                        <strong>Respecter les contraintes enseignants</strong>
                                        <br>
                                        <small style="color: #6c757d;">
                                            Analyser les remarques (matin/apr√®s-midi, jours indisponibles, etc.)
                                        </small>
                                    </span>
                                </label>

                                <!-- D√©tails des contraintes d√©tect√©es -->
                                <div id="constraintsDetectionSummary"
                                    style="margin-left: 28px; margin-top: 8px; padding: 12px; background: #fff; border-left: 3px solid #667eea; border-radius: 4px; display: none;">
                                    <div style="font-size: 0.85em; color: #495057;">
                                        <div id="constraintsSummaryContent"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e9ecef; text-align: right;">
                        <button id="btnResetOptOptions" class="btn btn-secondary" style="margin-right: 10px;">
                            R√©initialiser
                        </button>
                        <button id="btnCloseOptOptions" class="btn btn-secondary">
                            Fermer
                        </button>
                    </div>
                </div>

                <!-- Boutons -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button id="btnShowOptOptions" class="btn btn-secondary">
                        ‚öôÔ∏è Options avanc√©es
                    </button>

                    <button id="btnOptimizeSchedule" class="btn btn-primary"
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                        ‚ú® Optimiser l'EDT
                    </button>

                    <button id="btnResolveConflicts" class="btn btn-warning">
                        üîß R√©soudre les Conflits
                    </button>
                </div>
            </div>

            <!-- Filtres et recherche -->
            <div class="search-panel">
                <h3>üîç Filtres et Recherche</h3>
                <div class="search-inputs">
                    <input type="text" id="searchMatiere" placeholder="Filtrer par mati√®re...">
                    <input type="text" id="searchEnseignant" placeholder="Filtrer par enseignant...">
                    <input type="text" id="searchSalle" placeholder="Filtrer par salle...">
                    <input type="text" id="searchSectionGroupe" placeholder="Filtrer par section/groupe...">
                    <button id="btnClearFilters" class="btn btn-sm">üóëÔ∏è Effacer</button>
                </div>
            </div>

            <!-- S√©lecteur de vue -->
            <div class="view-selector">
                <label for="selectEDTView">Vue :</label>
                <select id="selectEDTView">
                    <option value="global">Vue Globale</option>
                    <option value="enseignant_selectionne">Enseignant S√©lectionn√©</option>
                </select>
            </div>

            <!-- Tableau EDT -->
            <div id="edtTableContainer">
                <table id="edtTable"></table>
            </div>
        </div>
        <!-- ===== ONGLET DASHBOARD ===== -->
        <div id="tab-dashboard" class="tab-pane">
            <div id="dashboardContainer"></div>
        </div>
        <!-- ===== ONGLET CONFIGURATION ===== -->

        <div id="tab-config" class="tab-pane">
            <h2>üîß Configuration</h2>

            <!-- Navigation sous-onglets -->
            <div class="sub-tabs-container">
                <button class="sub-tab-btn active" data-subtab="seances">üîß R√©glages</button>
                <button class="sub-tab-btn" data-subtab="matieres">üìö Mati√®res</button>
                <button class="sub-tab-btn" data-subtab="enseignants">üë®‚Äçüè´ Enseignants</button>
                <button class="sub-tab-btn" data-subtab="salles">üèõÔ∏è Salles</button>
                <button class="sub-tab-btn" data-subtab="filieres">üéì Fili√®res</button>
                <button class="sub-tab-btn" data-subtab="forfaits">üíº Forfaits</button>
            </div>

            <!-- ===== SOUS-ONGLET S√âANCES ===== -->
            <div id="subtab-seances" class="sub-tab-pane active">
                <div class="form-section">
                    <h3>‚ûï Ajouter une S√©ance</h3>
                    <form id="formAjouterSeance">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="selectJour">Jour *</label>
                                <select id="selectJour" required></select>
                            </div>
                            <div class="form-group">
                                <label for="selectCreneau">Cr√©neau *</label>
                                <select id="selectCreneau" required></select>
                            </div>
                            <div class="form-group">
                                <label for="selectFiliere">Fili√®re *</label>
                                <select id="selectFiliere" required></select>
                            </div>
                            <div class="form-group">
                                <label for="selectMatiere">Mati√®re *</label>
                                <select id="selectMatiere" required></select>
                            </div>
                            <div class="form-group">
                                <label for="selectType">Type *</label>
                                <select id="selectType" required></select>
                            </div>
                            <div class="form-group">
                                <label for="selectSection">Section *</label>
                                <select id="selectSection" required></select>
                            </div>
                            <div class="form-group" id="groupeTDTPContainer" style="display: none;">
                                <label for="selectGroupeTDTP">Groupe TD/TP *</label>
                                <select id="selectGroupeTDTP"></select>
                            </div>
                            <div class="form-group">
                                <label for="inputEnseignant1">Enseignant 1</label>
                                <select id="inputEnseignant1"></select>
                            </div>
                            <div class="form-group" id="enseignant2Container" style="display: none;">
                                <label for="inputEnseignant2" id="labelEnseignant2">Enseignant 2
                                    (Co-responsable)</label>
                                <select id="inputEnseignant2"></select>
                            </div>
                            <div class="form-group">
                                <label for="selectSalle">Salle</label>
                                <select id="selectSalle"></select>
                            </div>
                        </div>

                        <div id="matiereInfoDisplay" style="margin-top: 15px;"></div>

                        <!-- Aper√ßu des souhaits de l'enseignant s√©lectionn√© (si pr√©sent) -->
                        <div id="teacherWishesPreview" style="margin-top: 12px;"></div>

                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button type="submit" id="btnAjouterSeance" class="btn btn-primary">‚ûï Ajouter la
                                S√©ance</button>
                            <button type="button" id="btnCancelSeanceEdit" class="btn btn-secondary"
                                style="display: none;">‚ùå Annuler</button>
                            <button type="button" id="btnResetSeanceForm" class="btn btn-secondary">üîÑ
                                R√©initialiser</button>
                        </div>
                        <!-- Message d'aide apr√®s planification -->
                        <div id="exam-form-helper"
                            style="display:none; margin-top: 15px; padding: 12px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 6px;">
                            <strong>üí° Astuce :</strong>
                            Le formulaire reste pr√©-rempli pour vous permettre de cr√©er facilement un autre examen sur
                            le m√™me cr√©neau.
                            Modifiez juste le titre et/ou les mati√®res, puis cliquez √† nouveau sur "Planification
                            automatique".
                        </div>
                    </form>
                </div>
                <div class="form-section">
                    <h3>‚öôÔ∏è R√©glages G√©n√©raux</h3>
                    <div id="configGeneralSettingsContainer"></div>
                </div>
            </div>

            <!-- ===== SOUS-ONGLET MATI√àRES ===== -->
            <div id="subtab-matieres" class="sub-tab-pane">
                <!-- Formulaire Ajouter Mati√®re -->
                <div class="form-section">
                    <h3>‚ûï Ajouter une Mati√®re</h3>
                    <form id="formAjouterMatiere">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="inputNomMatiere">Nom de la mati√®re *</label>
                                <input type="text" id="inputNomMatiere" required placeholder="Ex: M√©canique Quantique">
                            </div>
                            <div class="form-group">
                                <label for="selectFiliereMatiere">Fili√®re *</label>
                                <select id="selectFiliereMatiere" required></select>
                            </div>
                            <div class="form-group">
                                <label for="selectDepartementMatiere">D√©partement</label>
                                <select id="selectDepartementMatiere">
                                    <option value="">-- S√©lectionner --</option>
                                    <!-- Rempli dynamiquement par populateFormSelects() -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="inputSectionsCours">Sections *</label>
                                <input type="number" id="inputSectionsCours" min="0" value="1" required>
                            </div>
                            <div class="form-group">
                                <label for="inputTDGroups">Groupes TD *</label>
                                <input type="number" id="inputTDGroups" min="0" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="inputTPGroups">Groupes TP *</label>
                                <input type="number" id="inputTPGroups" min="0" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="inputVolumeCoursHTP">Volume hTP Cours *</label>
                                <input type="number" id="inputVolumeCoursHTP" min="0" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="inputVolumeTDHTP">Volume hTP TD *</label>
                                <input type="number" id="inputVolumeTDHTP" min="0" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="inputVolumeTPHTP">Volume hTP TP *</label>
                                <input type="number" id="inputVolumeTPHTP" min="0" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="inputNbEnseignantsTP">Nb Enseignants TP *</label>
                                <input type="number" id="inputNbEnseignantsTP" min="1" value="1" required>
                            </div>
                        </div>

                        <div id="vhtPreview" style="margin-top: 15px;"></div>

                        <div style="margin-top: 20px;">
                            <button type="submit" class="btn btn-primary">‚ûï Ajouter la Mati√®re</button>
                        </div>
                    </form>
                </div>

                <!-- Liste des Mati√®res -->
                <div class="form-section">
                    <h3>üìö Mati√®res Enregistr√©es</h3>
                    <div id="configMatieresListContainer"></div>
                </div>
            </div>

            <!-- ===== SOUS-ONGLET ENSEIGNANTS ===== -->
            <div id="subtab-enseignants" class="sub-tab-pane">
                <!-- Formulaire Ajouter Enseignant -->
                <div class="form-section">
                    <h3>‚ûï Ajouter un Enseignant</h3>
                    <form id="formAjouterEnseignant">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="inputNomEnseignant">Nom de l'enseignant *</label>
                                <input type="text" id="inputNomEnseignant" required placeholder="Ex: Dr. Ahmed Bennani">
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <button type="submit" class="btn btn-primary">‚ûï Ajouter l'Enseignant</button>
                        </div>
                    </form>
                </div>

                <!-- Liste des Enseignants -->
                <div class="form-section">
                    <h3>üë®‚Äçüè´ Enseignants Enregistr√©s</h3>
                    <div id="configEnseignantsListContainer"></div>
                </div>
            </div>

            <!-- ===== SOUS-ONGLET SALLES ===== -->
            <div id="subtab-salles" class="sub-tab-pane">
                <!-- Formulaire Ajouter Salle -->
                <div class="form-section">
                    <h3>‚ûï Ajouter une Salle</h3>
                    <form id="formAjouterSalle">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="inputNomSalle">Nom de la salle *</label>
                                <input type="text" id="inputNomSalle" required placeholder="Ex: S1">
                            </div>
                            <div class="form-group">
                                <label for="selectTypeSalle">Type de salle *</label>
                                <select id="selectTypeSalle" required></select>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <button type="submit" class="btn btn-primary">‚ûï Ajouter la Salle</button>
                        </div>
                    </form>
                </div>

                <!-- Liste des Salles -->
                <div class="form-section">
                    <h3>üèõÔ∏è Salles Enregistr√©es</h3>
                    <div id="configSallesListContainer"></div>
                </div>
                <div class="config-section">
                    <h3 class="config-title">Salles Sp√©cifiques par Fili√®re</h3>
                    <p class="config-description">
                        D√©finissez un "pool" de salles prioritaires pour les "Cours" ou "TD".
                        La planification auto les utilisera en priorit√©.
                        (Utilisez <strong>CTRL+Clic</strong> ou <strong>CMD+Clic</strong> pour en s√©lectionner
                        plusieurs).
                    </p>

                    <div id="configSallesParFiliereContainer" class="config-list">
                    </div>
                </div>
            </div>

            <!-- ===== SOUS-ONGLET FILI√àRES ===== -->
            <div id="subtab-filieres" class="sub-tab-pane">
                <!-- Formulaire Ajouter Fili√®re -->
                <div class="form-section">
                    <h3>‚ûï Ajouter une Fili√®re</h3>
                    <form id="formAjouterFiliere">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="inputNomFiliere">Nom de la fili√®re *</label>
                                <input type="text" id="inputNomFiliere" required placeholder="Ex: S5 P">
                            </div>
                            <div class="form-group">
                                <label for="selectSessionFiliere">Session *</label>
                                <select id="selectSessionFiliere" required></select>
                                <label for="selectDepartementFiliere">D√©partement *</label>
                                <select id="selectDepartementFiliere" required>
                                    <option value="">-- S√©lectionner --</option>
                                    <!-- Les options seront remplies dynamiquement par populateFormSelects -->
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <button type="submit" class="btn btn-primary">‚ûï Ajouter la Fili√®re</button>
                        </div>
                    </form>
                </div>

                <!-- Liste des Fili√®res -->
                <div class="form-section">
                    <h3>üéì Fili√®res Enregistr√©es</h3>
                    <div id="configFilieresListContainer"></div>
                </div>
            </div>


            <!-- ===== SOUS-ONGLET FORFAITS ===== -->
            <div id="subtab-forfaits" class="sub-tab-pane">
                <!-- Formulaire Ajouter Forfait -->
                <div class="form-section">
                    <h3>‚ûï Ajouter un Forfait</h3>
                    <form id="formAjouterForfait">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="selectEnseignantForfait">Enseignant *</label>
                                <select id="selectEnseignantForfait" required>
                                    <option value="">-- S√©lectionner un enseignant --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="selectNatureForfait">Nature du forfait *</label>
                                <select id="selectNatureForfait" required>
                                    <option value="">-- S√©lectionner --</option>
                                    <option value="Chef de d√©partement">Chef de d√©partement</option>
                                    <option value="Coll√®ge">Coll√®ge</option>
                                    <option value="Master">Master</option>
                                    <option value="Coordonnateur de fili√®re">Coordonnateur de fili√®re</option>
                                    <option value="Autres">Autres</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="inputVolumeHoraireForfait">Volume horaire (h) *</label>
                                <input type="number" id="inputVolumeHoraireForfait" min="0" step="0.5" required
                                    placeholder="Ex: 50">
                            </div>
                            <div class="form-group">
                                <label for="inputDescriptionForfait">Description</label>
                                <input type="text" id="inputDescriptionForfait" placeholder="Description optionnelle">
                            </div>
                        </div>
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button type="submit" id="btnAjouterForfait" class="btn btn-primary">‚ûï Ajouter le
                                Forfait</button>
                            <button type="button" id="btnCancelForfaitEdit" class="btn btn-secondary"
                                style="display: none;">‚ùå Annuler</button>
                            <button type="button" id="btnResetForfaitForm" class="btn btn-secondary">üîÑ
                                R√©initialiser</button>
                        </div>
                    </form>
                </div>

                <!-- Liste des Forfaits -->
                <div class="form-section">
                    <h3>üíº Forfaits Enregistr√©s</h3>
                    <div id="forfaitsListContainer"></div>
                </div>
            </div>

        </div>


        <!-- ===== ONGLET VOLUMES ===== -->
        <div id="tab-volumes" class="tab-pane">
            <h2>üìä Volumes Horaires</h2>
            <div id="volumesContainer"></div>
        </div>
        <!-- ===== ONGLET STATISTIQUES ===== -->
        <div id="tab-stats" class="tab-pane">
            <h2>üìà Statistiques</h2>
            <div id="statsContainer"></div>
        </div>

        <!-- ===== ONGLET GESTION ===== -->
        <div id="tab-gestion" class="tab-pane">
            <h2>üë• Gestion des Ressources</h2>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                <!-- Liste Enseignants -->
                <div class="form-section">
                    <div id="teachersListContainer"></div>
                </div>

                <!-- Liste Mati√®res -->
                <div class="form-section">
                    <div id="subjectsListContainer"></div>
                </div>

                <!-- Liste Salles -->
                <div class="form-section">
                    <div id="roomsListContainer"></div>
                </div>
            </div>
        </div>
        <!-- ===== ONGLET GESTION SALLES ===== -->
        <div id="tab-salles" class="tab-pane">
            <div id="roomManagementContainer"></div>
        </div>

        <!-- ===== ONGLET SOUHAITS ENSEIGNANTS ===== -->
        <div id="tab-souhaits" class="tab-pane">
            <h2>üí≠ Gestion des Souhaits des Enseignants</h2>

            <!-- Import Souhaits -->
            <div class="form-section">
                <h3>üì• Importer les Souhaits depuis Excel</h3>
                <p style="margin-bottom: 15px; color: #6c757d;">
                    Dans l'onglet Rapports & Export, importez les souhaits de vos enseignants depuis un fichier Excel.
                    Le fichier doit contenir les colonnes : Enseignant, Choix1, C1, TD1, TP1, Choix2, C2, TD2, TP2,
                    Choix3, C3, TD3, TP3, Contraintes.
                </p>

                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">

                </div>

                <!-- Instructions -->
                <div
                    style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    <h4 style="margin-top: 0; color: #1976D2;">üìñ Instructions</h4>
                    <ol style="margin: 0; padding-left: 20px;">
                        <li>T√©l√©chargez le template Excel en cliquant sur "T√©l√©charger Template Excel"</li>
                        <li>Remplissez le fichier avec les souhaits de chaque enseignant</li>
                        <li>Pour chaque choix, indiquez le nombre de s√©ances souhait√©es (0 = refus, vide = flexible)
                        </li>
                        <li>Cliquez sur "Importer Souhaits" et s√©lectionnez votre fichier rempli</li>
                    </ol>
                </div>

                <!-- Format attendu -->
                <div style="background: #fff9e6; border-left: 4px solid #FFC107; padding: 15px; border-radius: 4px;">
                    <h4 style="margin-top: 0; color: #F57C00;">üìã Format du Fichier Excel</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="border: 1px solid #dee2e6; padding: 8px;">Enseignant</th>
                                <th style="border: 1px solid #dee2e6; padding: 8px;">Choix 1</th>
                                <th style="border: 1px solid #dee2e6; padding: 8px;">C1</th>
                                <th style="border: 1px solid #dee2e6; padding: 8px;">TD1</th>
                                <th style="border: 1px solid #dee2e6; padding: 8px;">TP1</th>
                                <th style="border: 1px solid #dee2e6; padding: 8px;">...</th>
                                <th style="border: 1px solid #dee2e6; padding: 8px;">Contraintes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="border: 1px solid #dee2e6; padding: 8px;">Dr. Ahmed Bennani</td>
                                <td style="border: 1px solid #dee2e6; padding: 8px;">M√©canique Quantique</td>
                                <td style="border: 1px solid #dee2e6; padding: 8px;">1</td>
                                <td style="border: 1px solid #dee2e6; padding: 8px;">2</td>
                                <td style="border: 1px solid #dee2e6; padding: 8px;">0</td>
                                <td style="border: 1px solid #dee2e6; padding: 8px;">...</td>
                                <td style="border: 1px solid #dee2e6; padding: 8px;">Disponible le matin</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Liste des Souhaits Actuels -->
            <div class="form-section">
                <h3>üë• Souhaits Actuels des Enseignants</h3>
                <div id="wishesListContainer">
                    <p class="empty-message">Chargement des souhaits...</p>
                </div>
            </div>

            <!-- Formulaire de Saisie Manuel -->
            <div class="form-section">
                <h3>‚úçÔ∏è Saisir/Modifier les Souhaits Manuellement</h3>
                <form id="formSouhaitsEnseignant">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="selectEnseignantSouhaits">Enseignant *</label>
                            <select id="selectEnseignantSouhaits" required>
                                <option value="">-- S√©lectionner un enseignant --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Choix 1 -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="margin-top: 0;">1er Choix</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="inputChoix1">Mati√®re</label>
                                <select id="inputChoix1">
                                    <option value="">-- S√©lectionner --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="inputC1">Nb Cours</label>
                                <input type="number" id="inputC1" min="0" placeholder="0 = refus">
                            </div>
                            <div class="form-group">
                                <label for="inputTD1">Nb TD</label>
                                <input type="number" id="inputTD1" min="0" placeholder="0 = refus">
                            </div>
                            <div class="form-group">
                                <label for="inputTP1">Nb TP</label>
                                <input type="number" id="inputTP1" min="0" placeholder="0 = refus">
                            </div>
                        </div>
                    </div>

                    <!-- Choix 2 -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4 style="margin-top: 0;">2√®me Choix</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="inputChoix2">Mati√®re</label>
                                <select id="inputChoix2">
                                    <option value="">-- S√©lectionner --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="inputC2">Nb Cours</label>
                                <input type="number" id="inputC2" min="0" placeholder="0 = refus">
                            </div>
                            <div class="form-group">
                                <label for="inputTD2">Nb TD</label>
                                <input type="number" id="inputTD2" min="0" placeholder="0 = refus">
                            </div>
                            <div class="form-group">
                                <label for="inputTP2">Nb TP</label>
                                <input type="number" id="inputTP2" min="0" placeholder="0 = refus">
                            </div>
                        </div>
                    </div>

                    <!-- Choix 3 -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4 style="margin-top: 0;">3√®me Choix</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="inputChoix3">Mati√®re</label>
                                <select id="inputChoix3">
                                    <option value="">-- S√©lectionner --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="inputC3">Nb Cours</label>
                                <input type="number" id="inputC3" min="0" placeholder="0 = refus">
                            </div>
                            <div class="form-group">
                                <label for="inputTD3">Nb TD</label>
                                <input type="number" id="inputTD3" min="0" placeholder="0 = refus">
                            </div>
                            <div class="form-group">
                                <label for="inputTP3">Nb TP</label>
                                <input type="number" id="inputTP3" min="0" placeholder="0 = refus">
                            </div>
                        </div>
                    </div>

                    <!-- Contraintes -->
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="inputContraintes">Contraintes et Remarques</label>
                        <textarea id="inputContraintes" rows="3"
                            placeholder="Ex: Disponible uniquement le matin, Pr√©f√®re les TD aux TP..."></textarea>
                    </div>

                    <div style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">üíæ Enregistrer les Souhaits</button>
                        <button type="button" id="btnResetWishesForm" class="btn btn-secondary">üîÑ
                            R√©initialiser</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- ===== ONGLET RAPPORTS ===== -->
        <div id="tab-rapports" class="tab-pane">
            <h2>üìÑ Rapports & Export</h2>

            <!-- Export EDT -->
            <div class="export-section">
                <h3>üì• Export de l'Emploi du Temps</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="btnExportPDF" class="btn btn-primary">üìÑ Exporter en PDF</button>
                    <button id="btnExportExcel" class="btn btn-success">üìó Exporter en Excel</button>
                    <button id="btnExportTeachersSchedules" class="btn btn-info">üë®‚Äçüè´ EDT Enseignants (PDF)</button>
                </div>
            </div>

            <!-- Export Volumes -->
            <div class="export-section">
                <h3>üìä Export des Volumes Horaires</h3>
                <button id="btnExportVolumes" class="btn btn-info">üìä Exporter Volumes (Excel)</button>
            </div>

            <!-- Import -->
            <div class="import-section">
                <h3>üì• Imports</h3>

                <div class="import-group">
                    <h4>Souhaits des Enseignants</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="btnImportWishes" class="btn btn-secondary">üì• Importer Souhaits (Excel)</button>
                        <button id="btnDownloadWishesTemplate" class="btn btn-sm">üìã T√©l√©charger Template</button>
                    </div>
                    <input type="file" id="fileImportWishes" accept=".xlsx,.xls" style="display: none;">
                </div>

                <div class="import-group">
                    <h4>Mati√®res</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="btnImportSubjects" class="btn btn-secondary">üì• Importer Mati√®res (Excel)</button>
                        <button id="btnDownloadSubjectsTemplate" class="btn btn-sm">üìã T√©l√©charger Template</button>
                    </div>
                    <input type="file" id="fileImportSubjects" accept=".xlsx,.xls" style="display: none;">
                </div>
                <!-- Import Fili√®res -->
                <div class="import-group">
                    <h4>Fili√®res</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="btnImportFilieres" class="btn btn-secondary">üì• Importer Fili√®res (Excel)</button>
                        <button id="btnDownloadFilieresTemplate" class="btn btn-sm">üìã T√©l√©charger Template</button>
                    </div>
                    <input type="file" id="inputImportFilieres" accept=".xlsx,.xls" style="display: none;">
                    <p class="help-text" style="margin-top:8px; color:#6c757d;">
                        Fichier Excel : colonnes [Fili√®re, Session (Automne|Printemps), D√©partement]. Une en-t√™te est
                        tol√©r√©e.
                    </p>
                </div>
            </div>

            <!-- Gestion Projet -->
            <div class="export-section">
                <h3>üíæ Gestion du Projet</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <!-- Export/Import Projet buttons removed to avoid conflicts with custom backup UI -->
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="btnResetEDT" class="btn btn-warning">üîÑ R√©initialiser EDT Session</button>
                    <button id="btnResetProject" class="btn btn-danger">‚ö†Ô∏è R√©initialiser Projet Complet</button>
                </div>
            </div>

            <!-- Journal des op√©rations -->
            <div id="log-container" class="form-section">
                <h3>üìã Journal des Op√©rations
                    <button id="btnClearLog" class="btn btn-sm btn-danger" style="float: right;">üóëÔ∏è Vider</button>
                </h3>
                <div id="messages"></div>
            </div>
        </div>


        <!-- ===== ONGLET EXAMENS ===== -->
        <div id="tab-examens" class="tab-pane">
            <h2>üìù Gestion des Examens</h2>

            <!-- Sous-onglets pour l'onglet Examens -->
            <div class="sub-tabs-container" style="margin-bottom:12px;">
                <button class="sub-tab-btn active" data-subtab="subtab-exam-gestion">üë©‚Äçüíº Gestion des examens</button>
                <button class="sub-tab-btn" data-subtab="subtab-exam-timetable">üìÜ Emploi du temps</button>
                <button class="sub-tab-btn" data-subtab="subtab-exam-rooms">üèõÔ∏è Salles d'examen</button>
            </div>

            <!-- Sous-onglet : gestion des examens (par d√©faut visible) -->
            <div id="subtab-exam-gestion" class="sub-tab-pane active">
                <div class="form-section" style="margin-bottom: 30px;">
                    <button id="btnOpenExamWizard" class="btn btn-lg btn-primary"
                        style="width: 100%; padding: 25px; font-size: 1.3em; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s ease;"
                        onmouseover="this.style. transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)';">
                        ‚ú® Cr√©er un nouvel examen (Assistant intuitif)
                    </button>
                    <p style="text-align: center; color: #6c757d; margin-top: 10px; font-size: 0.95em;">
                        üí° Utilise l'assistant progressif pour une cr√©ation simplifi√©e
                    </p>
                </div>

                <!-- S√©parateur visuel -->
                <div style="border-top: 2px solid #e9ecef; margin: 30px 0; position: relative;">
                    <span
                        style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: white; padding: 0 15px; color: #6c757d; font-size: 0.9em;">
                        OU
                    </span>
                </div>
                <div class="form-section" id="legacy-exam-form">
                    <details>
                        <summary
                            style="cursor: pointer; padding: 15px; background: #f8f9fa; border-radius: 8px; font-weight: 600; font-size: 1.1em; margin-bottom: 20px;">
                            ‚úçÔ∏è Formulaire manuel (√©dition avanc√©e)
                        </summary>
                        <form id="formAjouterExamen">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="inputExamTitle">Titre *</label>
                                    <input type="text" id="inputExamTitle" required
                                        placeholder="Ex: Session Finale - M√©canique">
                                </div>
                                <div class="form-group">
                                    <label for="inputExamDate">Date *</label>
                                    <input type="date" id="inputExamDate" required>
                                </div>
                                <div class="form-group">
                                    <label for="inputExamStart">Heure d√©but *</label>
                                    <input type="time" id="inputExamStart" required>
                                </div>
                                <div class="form-group">
                                    <label for="inputExamEnd">Heure fin *</label>
                                    <input type="time" id="inputExamEnd" required>
                                </div>
                                <div class="form-group">
                                    <label for="inputExamSession">Session (Automne/Printemps)</label>
                                    <select id="inputExamSession">
                                        <option value="">-- S√©lectionner --</option>
                                        <option>Automne</option>
                                        <option>Printemps</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="inputExamFiliere">Fili√®re</label>
                                    <select id="inputExamFiliere">
                                        <option value="">-- S√©lectionner --</option>
                                        <!-- Options remplies dynamiquement depuis StateManager.state.filieres -->
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="inputExamDept">D√©partement</label>
                                    <select id="inputExamDept"></select>
                                </div>
                                <div class="form-group">
                                    <label for="inputExamSubjects">Mati√®res (s√©lectionner une ou plusieurs)</label>
                                    <select id="inputExamSubjects" multiple size="6" style="min-width:220px;">
                                        <!-- Options peupl√©es dynamiquement selon la fili√®re s√©lectionn√©e -->
                                    </select>
                                    <small class="help-text">S√©lectionnez les mati√®res associ√©es √† la fili√®re
                                        choisie.</small>
                                </div>
                                <div class="form-group">
                                    <label for="inputExamRooms">Salles (s√©par√©es par virgule)</label>
                                    <input type="text" id="inputExamRooms" placeholder="S1, S2">
                                </div>

                                <div class="form-group">
                                    <label for="inputExamStudentsCount">Nombre total d'√©tudiants</label>
                                    <input type="number" id="inputExamStudentsCount" min="0" placeholder="Ex: 120">
                                    <small class="help-text">Indiquer le nombre total d'√©tudiants concern√©s par
                                        l'examen.</small>
                                </div>
                                <!-- NOUVEAU : Indicateur de capacit√© -->
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <div id="exam-capacity-indicator"
                                        style="background: linear-gradient(135deg, #e7f3ff 0%, #f0e7ff 100%); border-left: 5px solid #667eea; padding: 15px; border-radius: 10px; display: none;">
                                        <div style="display: flex; justify-content: space-around; text-align: center;">
                                            <div>
                                                <div
                                                    style="font-size: 0.85em; color: #6c757d; text-transform: uppercase; margin-bottom: 5px;">
                                                    üè¢ Capacit√© totale</div>
                                                <div id="exam-total-capacity"
                                                    style="font-size: 1.8em; font-weight: bold; color: #667eea;">‚Äî</div>
                                            </div>
                                            <div>
                                                <div
                                                    style="font-size: 0. 85em; color: #6c757d; text-transform: uppercase; margin-bottom: 5px;">
                                                    ‚úÖ Capacit√© utilis√©e</div>
                                                <div id="exam-used-capacity"
                                                    style="font-size: 1.8em; font-weight: bold; color: #28a745;">0</div>
                                            </div>
                                            <div>
                                                <div
                                                    style="font-size: 0.85em; color: #6c757d; text-transform: uppercase; margin-bottom: 5px;">
                                                    üìä Capacit√© restante</div>
                                                <div id="exam-remaining-capacity"
                                                    style="font-size: 1.8em; font-weight: bold; color: #17a2b8;">‚Äî</div>
                                                <div id="exam-remaining-percentage"
                                                    style="font-size: 0.75em; color: #6c757d; margin-top: 3px;">‚Äî</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label for="inputExamNotes">Remarques</label>
                                    <textarea id="inputExamNotes" rows="2"></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 12px; display:flex; gap:10px;">
                                <button type="submit" class="btn btn-primary">üíæ Enregistrer l'Examen</button>
                                + <button type="button" id="btnAutoScheduleCurrentExam" class="btn btn-warning">‚öôÔ∏è
                                    Planification
                                    automatique</button>
                                + <button type="button" id="btnResetExamForm" class="btn btn-secondary">üîÑ
                                    R√©initialiser</button>
                            </div>
                        </form>
                    </details>
                </div>

                <div class="form-section">
                    <h3 style="display:flex; align-items:center; gap:12px;">
                        üìö Examens Planifi√©s
                        <!-- Bouton pour basculer vers le sous-onglet Emploi du temps 
                        <button id="btnShowExamTimetable" class="btn btn-sm btn-secondary"
                            title="Afficher l'emploi du temps" style="margin-left:8px; font-size:0.95em;">
                            üìÜ Emploi du temps
                        </button> -->
                    </h3>
                    <!-- toolbar pour les actions globales li√©es aux examens (ins√©rer juste avant #examsListContainer) -->
                    <div class="exams-toolbar" style="display:flex; gap:8px; align-items:center; margin:8px 0 12px;">
                        <button id="btnManageExamRooms" class="btn btn-secondary" type="button"
                            title="G√©rer la r√©partition des √©tudiants par salle">
                            ‚öôÔ∏è G√©rer r√©partition √©tudiants
                        </button>
                    </div>
                    <div id="examsListContainer">Chargement des examens...</div>
                </div>
            </div>

            <!-- Sous-onglet : Emploi du temps -->
            <div id="subtab-exam-timetable" class="sub-tab-pane" style="display:none;">

                <div class="form-section">
                    <h3 style="display:flex; align-items:center; gap:12px;">
                        üìÜ Emploi du temps ‚Äî Examens planifi√©s
                        <!-- Bouton d'export PDF pour l'emploi du temps -->
                        <button id="btnExportExamTimetablePDF" class="btn btn-sm btn-primary"
                            title="Exporter l'emploi du temps en PDF" style="margin-left:8px; font-size:0.95em;">
                            üìÑ Exporter l'examen PDF
                        </button>
                    </h3>
                    <p style="color:#6c757d; margin-bottom:8px;">
                        Vue r√©capitulative des examens par jour et cr√©neaux. Cliquez sur un examen pour afficher les
                        d√©tails.
                    </p>
                    <div id="examTimetableContainer" style="margin-top:12px;">Chargement de l'emploi du temps...</div>
                </div>
            </div>


            <!-- Sous-onglet : Configuration des salles d'examen -->
            <div id="subtab-exam-rooms" class="sub-tab-pane" style="display:none;">
                <div class="form-section">
                    <h3>üèõÔ∏è Configuration des Salles d'Examen</h3>
                    <p style="color:#6c757d; margin-bottom:8px;">
                        D√©finissez la capacit√© et le nombre de surveillants par salle pour l'organisation des examens.
                        S√©lectionnez une salle existante et ajoutez sa configuration.
                    </p>

                    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin-bottom:10px;">
                        <div style="display:flex; flex-direction:column;">
                            <label for="selectExamRoomForConfig">Salle</label>
                            <select id="selectExamRoomForConfig">
                                <option value="">-- S√©lectionner une salle --</option>
                            </select>
                        </div>

                        <div style="display:flex; flex-direction:column;">
                            <label for="inputExamRoomCapacity">Capacit√© (nb √©tudiants)</label>
                            <input type="number" id="inputExamRoomCapacity" min="0" placeholder="Ex: 120">
                        </div>

                        <div style="display:flex; flex-direction:column;">
                            <label for="inputExamRoomSupervisors">Nb surveillants</label>
                            <input type="number" id="inputExamRoomSupervisors" min="0" placeholder="Ex: 2">
                        </div>

                        <div>
                            <button id="btnAddExamRoomConfig" class="btn btn-secondary" type="button"
                                style="margin-top:22px;">
                                ‚ûï Ajouter / Mettre √† jour
                            </button>
                        </div>
                    </div>

                    <div id="examRoomConfigsContainer" style="margin-top:8px;">
                        <!-- List of configured exam rooms will be rendered here -->
                    </div>

                    <div style="margin-top:12px;">
                        <button id="btnSaveExamRoomConfigs" class="btn btn-primary">üíæ Enregistrer Configurations
                            Salles</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Footer -->
        <footer id="page-footer">
            Pr. Ibrahim Mrani - UCD - Version 2.9 Modulaire - D√©velopp√© par @mranii-cmd - 2025-11-04
        </footer>
    </div>

    <!-- Modale de dialogue -->
    <div id="dialogModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"
        role="dialog" aria-modal="true" aria-labelledby="dialogTitle"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">

        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md"
            style="background: white; border-radius: 12px; padding: 20px; max-width: 500px; width: 90%; display:flex; flex-direction:column; max-height: calc(100vh - 80px); overflow: hidden;">

            <div class="flex justify-between items-center border-b pb-3 mb-4"
                style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e9ecef; padding-bottom: 12px; margin-bottom: 12px; flex: 0 0 auto;">
                <h3 id="dialogTitle" class="text-xl font-bold" style="font-size: 1.3em; font-weight: bold;">Notification
                </h3>
                <button id="closeDialogBtn" class="text-gray-500 hover:text-gray-800 text-2xl leading-none"
                    aria-label="Fermer la bo√Æte de dialogue"
                    style="background: none; border: none; font-size: 1.5em; cursor: pointer;">&times;</button>
            </div>
            <div id="dialogBody" class="text-gray-700"
                style="line-height: 1.6; overflow:auto; flex:1 1 auto; margin-bottom:12px; padding-right:6px;"></div>
            <div class="flex justify-end gap-4"
                style="display: flex; justify-content: flex-end; gap: 10px; flex:0 0 auto; margin-top:6px;">
                <button id="dialogCancelBtn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
                    aria-label="Annuler"
                    style="padding: 10px 20px; background: #e9ecef; border: none; border-radius: 6px; cursor: pointer;">Annuler</button>
                <button id="dialogConfirmBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                    aria-label="Confirmer"
                    style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Focus-trap & restore script for the modal (lightweight, non-intrusive) -->
    <script>
        (function () {
            const modal = document.getElementById('dialogModal');
            if (!modal) return;
            let lastFocused = null;
            // utility: first focusable inside modal
            function getFirstFocusable(root) {
                if (!root) return null;
                const selectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
                return root.querySelector(selectors);
            }
            // observe style attribute changes to detect show/hide
            const obs = new MutationObserver(() => {
                try {
                    const isVisible = window.getComputedStyle(modal).display !== 'none' && modal.offsetParent !== null;
                    if (isVisible) {
                        // store last focused
                        lastFocused = document.activeElement;
                        // focus first focusable (close button preferred)
                        const closeBtn = document.getElementById('closeDialogBtn');
                        const firstFocus = closeBtn || getFirstFocusable(modal);
                        if (firstFocus) firstFocus.focus();
                        // simple trap: prevent tabbing out by capturing focusin and redirecting when needed
                        document.addEventListener('focusin', focusInHandler);
                    } else {
                        document.removeEventListener('focusin', focusInHandler);
                        // restore previous focus
                        if (lastFocused && typeof lastFocused.focus === 'function') {
                            lastFocused.focus();
                            lastFocused = null;
                        }
                    }
                } catch (e) { /* noop */ }
            });
            function focusInHandler(e) {
                if (!modal.contains(e.target)) {
                    // redirect focus back to modal
                    const first = getFirstFocusable(modal) || modal;
                    if (first) first.focus();
                }
            }
            obs.observe(modal, { attributes: true, attributeFilter: ['style', 'class'] });

            // ensure close button restores focus on click
            const closeBtn = document.getElementById('closeDialogBtn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    try {
                        modal.style.display = 'none';
                    } catch (e) { /* noop */ }
                });
            }
        })();
    </script>

    <!-- Shortcut script for Configuration ‚Üí S√©ances -->
    <script>
        (function () {
            /**
             * Open Configuration -> S√©ances
             * Strategy:
             * 1) Try to click the main tab button with data-tab="config"
             * 2) Then click the subtab button data-subtab="seances"
             * 3) If tabs are managed by JS and click doesn't work immediately, try small delays
             */
            function openSeancesConfigShortcut() {
                try {
                    const configTabBtn = document.querySelector('.tab-btn[data-tab="config"]');
                    if (configTabBtn) {
                        // Click main config tab
                        configTabBtn.click();

                        // After a short delay allow sub-tabs to be available/activated
                        setTimeout(() => {
                            const subtabBtn = document.querySelector('.sub-tab-btn[data-subtab="seances"]');
                            if (subtabBtn) {
                                subtabBtn.click();
                                // focus for accessibility
                                subtabBtn.focus();
                            } else {
                                // If subtab button not present yet, attempt again shortly
                                setTimeout(() => {
                                    const subtabBtn2 = document.querySelector('.sub-tab-btn[data-subtab="seances"]');
                                    if (subtabBtn2) {
                                        subtabBtn2.click();
                                        subtabBtn2.focus();
                                    } else {
                                        console.info('Shortcut S√©ances: sous-onglet non trouv√©.');
                                    }
                                }, 150);
                            }
                        }, 80);
                        return;
                    }

                    // fallback: try to open config via element with id or data-open
                    const configToggle = document.querySelector('#btn-config, [data-open="configuration"]');
                    if (configToggle) {
                        configToggle.click();
                        setTimeout(() => {
                            const subtab = document.querySelector('.sub-tab-btn[data-subtab="seances"]');
                            if (subtab) subtab.click();
                        }, 120);
                        return;
                    }

                    // final fallback: try to show a helpful message in console/notification area
                    console.info('Raccourci S√©ances : contr√¥le d\'onglet non trouv√© automatiquement.');
                } catch (err) {
                    console.error('openSeancesConfigShortcut error', err);
                }
            }

            // Attach listener after DOM is ready
            document.addEventListener('DOMContentLoaded', () => {
                const btn = document.getElementById('btnShortcutSeances');
                if (btn) {
                    btn.addEventListener('click', openSeancesConfigShortcut);
                }
            });

            // Also attach in case DOMContentLoaded already fired
            const btnImmediate = document.getElementById('btnShortcutSeances');
            if (btnImmediate) btnImmediate.addEventListener('click', openSeancesConfigShortcut);
            function attachShortcutOnce() {
                const btn = document.getElementById('btnShortcutSeances');
                if (!btn) return;
                if (btn.dataset.shortcutAttached) return;
                btn.addEventListener('click', openSeancesConfigShortcut);
                btn.dataset.shortcutAttached = '1';
            }

            // Attacher apr√®s DOM ready (ou imm√©diatement si possible) ‚Äî safe gr√¢ce au guard
            document.addEventListener('DOMContentLoaded', attachShortcutOnce);
            attachShortcutOnce(); // si DOMContentLoaded d√©j√† pass√©, l'appel imm√©diat attache ; sinon no-op
        })();
        // Script pour g√©rer l'affichage des d√©tails des pr√©f√©rences
        // Script pour g√©rer l'affichage des d√©tails des pr√©f√©rences
        (function () {
            // Attendre que le DOM soit compl√®tement charg√©
            function initOptionsToggles() {
                // Toggle pour "Cr√©neaux pr√©f√©r√©s"
                const checkboxPreferred = document.getElementById('optPreferredSlots');
                const detailsPreferred = document.getElementById('preferredSlotsDetails');

                if (checkboxPreferred && detailsPreferred) {
                    const togglePreferred = function () {
                        detailsPreferred.style.display = checkboxPreferred.checked ? 'block' : 'none';
                    };
                    togglePreferred();
                    checkboxPreferred.addEventListener('change', togglePreferred);
                    console.log('Preferred slots toggle initialized');
                }

                // Toggle pour "Regrouper les mati√®res"
                const checkboxGroup = document.getElementById('optGroupSubjects');
                const detailsGroup = document.getElementById('groupSubjectsDetails');

                if (checkboxGroup && detailsGroup) {
                    const toggleGroup = function () {
                        detailsGroup.style.display = checkboxGroup.checked ? 'block' : 'none';
                    };
                    toggleGroup();
                    checkboxGroup.addEventListener('change', toggleGroup);
                    console.log('Group subjects toggle initialized');
                }
            }

            // Essayer d'initialiser imm√©diatement
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initOptionsToggles);
            } else {
                initOptionsToggles();
            }
        })();

    </script>
    <script>  window.EDT_API_BASE = 'http://localhost:4000/api';
        window.EDT_DEV_ALLOW_FAKE_LOGIN = false; </script>
    <!-- Application principale (ES6 Module) -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
    <script type="module" src="src/js/panexam.js"></script>
    <script type="module" src="src/js/exportExamPdf.js"></script>

    <!--<script src="src/js/edt-compat.js"></script> -->

    <script src="./js/backup-service.js"></script>
    <script src="./js/backup-importer.js"></script>

    <!-- Biblioth√®ques externes -->
    <script src="lib/jszip.min.js" defer></script>
    <script src="lib/xlsx.full.min.js" defer></script>
    <script src="lib/jspdf.umd.min.js" defer></script>
    <script src="lib/jspdf.plugin.autotable.min.js" defer></script>
    <script src="lib/html2canvas.min.js" defer></script>
    <script src="lib/chart.umd.min.js" defer></script>
    <script src="lib/purify.min.js" defer></script>

    <script>
        /* Ensure a tiny, early updater for the Undo/Redo UI to avoid timing races.
           Defines window.__updateUndoUI() and subscribes to the 'undo:stackChanged' event.
           Safe / idempotent: if undo UI not present yet, it will be a no-op. */
        (function () {
            function updateButtons() {
                try {
                    var undoBtn = document.getElementById('btnUndo');
                    var redoBtn = document.getElementById('btnRedo');
                    var canU = window.StateManager && typeof window.StateManager.canUndo === 'function' ? !!window.StateManager.canUndo() : false;
                    var canR = window.StateManager && typeof window.StateManager.canRedo === 'function' ? !!window.StateManager.canRedo() : false;
                    if (undoBtn) undoBtn.disabled = !canU;
                    if (redoBtn) redoBtn.disabled = !canR;
                } catch (e) { /* noop */ }
            }

            // Expose a global helper used by StateManager to force UI update (covers races)
            try { window.__updateUndoUI = updateButtons; } catch (e) { /* noop */ }

            // Listen to the global event (if dispatched)
            try { window.addEventListener('undo:stackChanged', updateButtons); } catch (e) { /* noop */ }

            // Also update once when DOM is ready (covers case where actions happened before UI built)
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function () { setTimeout(updateButtons, 10); });
            } else {
                setTimeout(updateButtons, 10);
            }
        })();
    </script>

    <script type="module" src="src/js/main.js" defer></script>

    <script src="src/js/ui/undo-ui.js" defer></script>
    <!-- Module to manage time slots (creneaux) -->
    <script type="module" src="src/js/creneaux-manager.js" defer></script>
    <script>
        (function () {
            function updateUndoBtn() {
                try {
                    var btn = document.getElementById('btnUndo');
                    if (!btn) return;
                    var can = (window.StateManager && typeof window.StateManager.canUndo === 'function') ? window.StateManager.canUndo() : false;
                    btn.disabled = !can;
                } catch (e) { }
            }
            document.addEventListener('DOMContentLoaded', function () {
                var btn = document.getElementById('btnUndo');
                if (!btn) return;
                btn.addEventListener('click', function (e) {
                    e && e.preventDefault && e.preventDefault();
                    try {
                        if (window.StateManager && typeof window.StateManager.undo === 'function') {
                            var ok = window.StateManager.undo();
                            if (!ok) alert('Aucune action √† annuler.');
                        } else {
                            alert('Fonction undo non disponible.');
                        }
                    } catch (err) { console.error('Undo failed', err); alert('Undo failed: ' + (err && err.message)); }
                    setTimeout(updateUndoBtn, 50);
                });
                // update initially and on some events
                updateUndoBtn();
                // attempt to update when state changes ‚Äî if StateManager.notify exists we can subscribe instead
                try {
                    if (window.StateManager && typeof window.StateManager.subscribe === 'function') {
                        window.StateManager.subscribe('stateChanged', updateUndoBtn);
                    }
                } catch (e) { }
                // also periodically enable when stack changes
                setInterval(updateUndoBtn, 1500);
            });
        })();
    </script>
</body>

</html>